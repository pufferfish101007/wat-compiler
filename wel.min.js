var V=/(?<comment>;;.*|\(;[^]*?;\))|"(?<string>(?:\\"|[^"])*?)"|(?<param>offset|align|shared|funcref)=?|(?<hex>([+-]?nan:)?[+-]?0x[0-9a-f.p+-_]+)|(?<number>[+-]?inf|[+-]?nan|[+-]?\d[\d.e_+-]*)|(?<instr>[a-z][a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)|\$(?<label>[a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)|(?<lparen>\()|(?<rparen>\))|(?<nul>[ \t\n]+)|(?<error>.)/gi;function z(n){let t={},e={},s=n.matchAll(V);function o(){let i=s.next();if(i.done)return{value:{value:null,kind:"eof",index:n.length},done:!0};let[a,l]=Object.entries(i.value.groups).filter(m=>m[1]!=null)[0];return{value:{value:l,kind:a,index:i.value.index},done:!1}}function _(){t=e;do e=o().value;while(e.kind==="nul"||e.kind==="comment");return t}function b(i,a){return i!=null?a!=null?a===e.value:i===e.kind:e}function p(i,a){if(i===e.kind)if(a!=null){if(a===e.value)return _()}else return _();return null}function c(i,a){let l=p(i,a);if(!l)throw new SyntaxError("Unexpected token: "+e.value+`
        expected: `+i+(a?' "'+a+'"':"")+`
    but received: `+e.kind+`
     at position: `+e.index);return l}return{[Symbol.iterator](){return this},next:o,advance:_,peek:b,accept:p,expect:c,start:_}}function*I(n){for(n=Y(n);;){let t=Number(n&0x7Fn);if(n>>=7n,n===0n&&(t&64)==0||n===-1n&&(t&64)!=0){yield t;break}yield t|128}}function*A(n){let t=0,e=Math.ceil(Math.log2(Math.abs(n))),s=n<0,o=!0;for(;o;)t=n&127,n=n>>7,s&&(n=n|-(1<<e-7)),n==0&&(t&64)==0||n==-1&&(t&64)==64?o=!1:t=t|128,yield t}function*x(n,t=0){let e=0;do e=n&127,n=n>>7,(n!=0||t>0)&&(e=e|128),yield e,t--;while(n!=0||t>-1)}var v=new DataView(new BigInt64Array(1).buffer);function Y(n){return v.setBigInt64(0,n),v.getBigInt64(0)}function*T(n){v.setFloat32(0,n);for(let t=4;t--;)yield v.getUint8(t)}function*B(n){v.setFloat64(0,n);for(let t=8;t--;)yield v.getUint8(t)}function E(n){n=n.toUpperCase();let t=n.indexOf("P"),e,s;t!==-1?(e=n.substring(0,t),s=parseInt(n.substring(t+1))):(e=n,s=0);let o=e.indexOf(".");if(o!==-1){let _=parseInt(e.substring(0,o),16),b=Math.sign(_);_=b*_;let p=e.length-o-1,c=parseInt(e.substring(o+1),16),r=p>0?c/Math.pow(16,p):0;b===0?r===0?e=b:Object.is(b,-0)?e=-r:e=r:e=b*(_+r)}else e=parseInt(e,16);return e*(t!==-1?Math.pow(2,s):1)}var J=2147483648,W=2139095040;function*q(n){let t=parseInt(n.split("nan:")[1]);t|=W,n[0]==="-"&&(t|=J),v.setInt32(0,t);for(let e=4;e--;)yield v.getUint8(e)}var H=0x8000000000000000n,K=0x7ff0000000000000n;function*S(n){let t=BigInt(n.split("nan:")[1]);t|=K,n[0]==="-"&&(t|=H),v.setBigInt64(0,t);for(let e=8;e--;)yield v.getUint8(e)}var h={"type.i32":127,"type.i64":126,"type.f32":125,"type.f64":124,"type.void":64,"type.func":96,"type.funcref":112,"section.custom":0,"section.type":1,"section.import":2,"section.function":3,"section.table":4,"section.memory":5,"section.global":6,"section.export":7,"section.start":8,"section.element":9,"section.code":10,"section.data":11,"import.func":0,"import.table":1,"import.memory":2,"import.global":3,"export.function":0,"export.table":1,"export.memory":2,"export.global":3,"global.const":0,"global.var":1,"global.mut":1,"limits.min":0,"limits.minmax":1},U=["unreachable","nop","block","loop","if","else",,,,,,"end","br","br_if","br_table","return","call","call_indirect",,,,,,,,,"drop","select",,,,,"local.get","local.set","local.tee","global.get","global.set",,,,"i32.load","i64.load","f32.load","f64.load","i32.load8_s","i32.load8_u","i32.load16_s","i32.load16_u","i64.load8_s","i64.load8_u","i64.load16_s","i64.load16_u","i64.load32_s","i64.load32_u","i32.store","i64.store","f32.store","f64.store","i32.store8","i32.store16","i64.store8","i64.store16","i64.store32","memory.size","memory.grow","i32.const","i64.const","f32.const","f64.const","i32.eqz","i32.eq","i32.ne","i32.lt_s","i32.lt_u","i32.gt_s","i32.gt_u","i32.le_s","i32.le_u","i32.ge_s","i32.ge_u","i64.eqz","i64.eq","i64.ne","i64.lt_s","i64.lt_u","i64.gt_s","i64.gt_u","i64.le_s","i64.le_u","i64.ge_s","i64.ge_u","f32.eq","f32.ne","f32.lt","f32.gt","f32.le","f32.ge","f64.eq","f64.ne","f64.lt","f64.gt","f64.le","f64.ge","i32.clz","i32.ctz","i32.popcnt","i32.add","i32.sub","i32.mul","i32.div_s","i32.div_u","i32.rem_s","i32.rem_u","i32.and","i32.or","i32.xor","i32.shl","i32.shr_s","i32.shr_u","i32.rotl","i32.rotr","i64.clz","i64.ctz","i64.popcnt","i64.add","i64.sub","i64.mul","i64.div_s","i64.div_u","i64.rem_s","i64.rem_u","i64.and","i64.or","i64.xor","i64.shl","i64.shr_s","i64.shr_u","i64.rotl","i64.rotr","f32.abs","f32.neg","f32.ceil","f32.floor","f32.trunc","f32.nearest","f32.sqrt","f32.add","f32.sub","f32.mul","f32.div","f32.min","f32.max","f32.copysign","f64.abs","f64.neg","f64.ceil","f64.floor","f64.trunc","f64.nearest","f64.sqrt","f64.add","f64.sub","f64.mul","f64.div","f64.min","f64.max","f64.copysign","i32.wrap_i64","i32.trunc_f32_s","i32.trunc_f32_u","i32.trunc_f64_s","i32.trunc_f64_u","i64.extend_i32_s","i64.extend_i32_u","i64.trunc_f32_s","i64.trunc_f32_u","i64.trunc_f64_s","i64.trunc_f64_u","f32.convert_i32_s","f32.convert_i32_u","f32.convert_i64_s","f32.convert_i64_u","f32.demote_f64","f64.convert_i32_s","f64.convert_i32_u","f64.convert_i64_s","f64.convert_i64_u","f64.promote_f32","i32.reinterpret_f32","i64.reinterpret_f64","f32.reinterpret_i32","f64.reinterpret_i64"],G={get_local:"local.get",set_local:"local.set",tee_local:"local.tee",get_global:"global.get",set_global:"global.set","i32.trunc_s/f32":"i32.trunc_f32_s","i32.trunc_u/f32":"i32.trunc_f32_u","i32.trunc_s/f64":"i32.trunc_f64_s","i32.trunc_u/f64":"i32.trunc_f64_u","i64.extend_s/i32":"i64.extend_i32_s","i64.extend_u/i32":"i64.extend_i32_u","i64.trunc_s/f32":"i64.trunc_f32_s","i64.trunc_u/f32":"i64.trunc_f32_u","i64.trunc_s/f64":"i64.trunc_f64_s","i64.trunc_u/f64":"i64.trunc_f64_u","f32.convert_s/i32":"f32.convert_i32_s","f32.convert_u/i32":"f32.convert_i32_u","f32.convert_s/i64":"f32.convert_i64_s","f32.convert_u/i64":"f32.convert_i64_u","f32.demote/f64":"f32.demote_f64","f64.convert_s/i32":"f64.convert_i32_s","f64.convert_u/i32":"f64.convert_i32_u","f64.convert_s/i64":"f64.convert_i64_s","f64.convert_u/i64":"f64.convert_i64_u","f64.promote/f32":"f64.promote_f32"};for(let[n,t]of U.entries())t!=null&&(h[t]=n);for(let n in G){let t=U.indexOf(G[n]);h[n]=t}var y={};for(let n in h){y[n]=N(n);let[t,e]=n.split(".");e!=null&&(h[t]=h[t]??{},h[t][e]=h[n],y[t]=y[t]??{},y[t][e]=N(n))}var C={"i32.load":4,"i64.load":8,"f32.load":4,"f64.load":8,"i32.load8_s":1,"i32.load8_u":1,"i32.load16_s":2,"i32.load16_u":2,"i64.load8_s":1,"i64.load8_u":1,"i64.load16_s":2,"i64.load16_u":2,"i64.load32_s":4,"i64.load32_u":4,"i32.store":4,"i64.store":8,"f32.store":4,"f64.store":8,"i32.store8":1,"i32.store16":2,"i64.store8":1,"i64.store16":2,"i64.store32":4};function N(n){return function(t,e){return Q(n,t!=null&&!Array.isArray(t)?[t]:t,e!=null&&!Array.isArray(e)?[e]:e)}}var X={"f64.const":B,"f32.const":T};function*Q(n,t=[],e=[]){for(let s of e)switch(typeof s){case"number":yield s;break;default:yield*s;break}yield h[n];for(let s of t)switch(typeof s){case"bigint":yield*I(s);break;case"number":yield*(X[n]??A)(s);break;default:yield*s}}var Z=new TextEncoder("utf-8");function M(n){return[...Z.encode(n)]}function L(){return[...M("\0asm"),1,0,0,0]}function u(n,t){return[h.section[n],...x(t.length),...t]}function g(n){return[...x(n.length),...n.flat()]}function ee(n){let t=[],e=[],s;for(let o of n)o!==s&&e.length&&(t.push([...x(e.length),h.type[e[0]]]),e=[]),e.push(o),s=o;return e.length&&t.push([...x(e.length),h.type[e[0]]]),t}function P(n,t){return t!=null?[h.limits.minmax,...x(n),...x(t)]:[h.limits.min,...x(n)]}u.type=function(n){return u("type",g(n.map(([t,e])=>[h.type.func,...g(t.map(s=>h.type[s])),...g(e.map(s=>h.type[s]))])))};u.import=function(n){return u("import",g(n.map(([t,e,s,o])=>[...g(M(t)),...g(M(e)),h.import[s],...o.map(_=>[...x(_)])])))};u.function=function(n){return u("function",g(n.map(t=>[...x(t)])))};u.table=function(n){return u("table",g(n.map(([t,e,s])=>[h.type[t],...P(e,s)])))};u.memory=function(n){return u("memory",g(n.map(([t,e])=>P(t,e))))};u.global=function(n){return u("global",g(n.map(([t,e,s])=>[h.type[e],h.global[t],...s,h.end])))};u.export=function(n){return u("export",g(n.map(([t,e,s])=>[...g(M(t)),h.export[e],...x(s)])))};u.start=function(n){return u("start",[...x(n)])};u.element=function(n){return u("element",g(n.map(([t,e,s])=>[...x(t),...e,h.end,...g(s)])))};u.code=function(n){return u("code",g(n.map(([t,e])=>g([...g(ee(t)),...e,h.end]))))};u.data=function(n){return u("data",g(n.map(([t,e,s])=>[...x(t),...e,h.end,...g(s)])))};var $=class extends Array{log=[];write(t,e){return this.log.push(t,e),this.push(...t),this}get buffer(){return new Uint8Array(this)}},O=class{types=[];imports=[];tables=[];memories=[];globals=[];exports=[];starts="";elements=[];codes=[];datas=[];get funcs(){return this.codes.filter(t=>!t.imported)}ensureType(t,e){let s=[t.join(" "),e.join(" ")].join(),o=this.types.indexOf(s);return o>=0?o:this.types.push(s)-1}getGlobalIndexOf(t){return this.globals.find(e=>e.name===t).idx}getFunc(t){return this.codes.find(e=>e.name===t)}getMemory(t){return this.memories.find(e=>e.name===t)}getType(t){return this.types[t]}type(t,e,s){return this.types[t]=this.ensureType(e,s),this}import(t,e,s,o,_,b){if(t==="func"){let p=this._func(e,_,b,[],[],!1,!0);this.imports.push({mod:s,field:o,type:t,desc:[p.type_idx]})}return this}table(t,e,s){return this.tables.push({type:t,min:e,max:s}),this}memory(t,e,s){return this.memories.push({name:t,min:e,max:s}),this}global(t,e,s,o){let _=this.globals.length;return this.globals.push({idx:_,name:t,valtype:s,mut:e,expr:o}),this}export(t,e,s){return this.exports.push({type:t,name:e,export_name:s}),this}start(t){return this.starts=t,this}elem(t,e){return this.elements.push({offset_idx_expr:t,codes:e}),this}_func(t,e=[],s=[],o=[],_=[],b=!1,p=!1){let c=this.ensureType(e,s),i={idx:this.codes.length,name:t,type_idx:c,locals:o,body:_,imported:p};return this.codes.push(i),b&&this.export("func",t,t),i}func(...t){return this._func(...t),this}data(t,e){return this.datas.push({offset_idx_expr:t,bytes:e}),this}build(){console.time("module build");let t=new $;return t.write(L()),t.write(u.type(this.types.map(e=>e.split(",").map(s=>s.split(" ").filter(Boolean))))),this.imports.length&&t.write(u.import(this.imports.map(e=>[e.mod,e.field,e.type,e.desc]))),t.write(u.function(this.funcs.map(e=>e.type_idx))),this.elements.length&&t.write(u.table(this.tables.map(e=>[e.type,e.min,e.max]))),this.memories.length&&t.write(u.memory(this.memories.map(e=>[e.min,e.max]))),this.globals.length&&t.write(u.global(this.globals.map(e=>[e.mut,e.valtype,e.expr]))),this.exports.length&&t.write(u.export(this.exports.map(e=>e.type==="func"?[e.export_name,e.type,this.getFunc(e.name).idx]:e.type==="memory"?[e.export_name,e.type,this.getMemory(e.name).idx]:[]))),this.starts.length&&t.write(u.start(this.getFunc(this.starts).idx)),this.elements.length&&t.write(u.element(this.elements.map(e=>[0,e.offset_idx_expr,e.codes.map(s=>this.getFunc(s).idx)]))),t.write(u.code(this.funcs.map(e=>[e.locals,e.body]))),this.datas.length&&t.write(u.data(this.datas.map(e=>[0,e.offset_idx_expr,e.bytes]))),console.timeEnd("module build"),t}},D=O;var R=class{globals=[];types=[];funcs=[];lookup(t,e){let s;switch(e){case"call":s=this.funcs.map(o=>o.name).lastIndexOf(t);break;case"type":s=this.types.map(o=>o.name).lastIndexOf(t);break;default:s=this.globals.map(o=>o.name).lastIndexOf(t)}return x(s)}};function j(n){let t=new D,e=new R,s=[];function o(r,i=e,a="i32"){switch(r.kind){case"number":{if(r.value==="inf"||r.value==="+inf")return Infinity;if(r.value==="-inf")return-Infinity;if(r.value==="nan"||r.value==="+nan")return NaN;if(r.value==="-nan")return NaN;if(a?.[0]==="f")return parseFloat(r.value)}case"hex":{let l;return a.indexOf("i64")===0?(r.value[0]==="-"?l=-BigInt(r.value.slice(1)):l=BigInt(r.value),l):a[0]==="f"?(r.value.indexOf("nan")>=0?a.indexOf("f32")===0?l=q(r.value):l=S(r.value):l=E(r.value),l):parseInt(r.value)}case"label":return i.lookup(r.value,a);default:return r.value}}class _{locals=[];depth=[];lookup(i,a){let l;switch(a){case"br":case"br_table":case"br_if":l=this.depth.lastIndexOf(i),~l&&(l=this.depth.length-1-l);break;default:l=this.locals.lastIndexOf(i)}return~l?x(l):e.lookup(i,a)}}function b(r,i,a){if(!(r in y)||typeof y[r]!="function")throw new Error("Unknown instruction: "+r);return[...y[r](i,a)]}function p(r,i=e){let a={offset:0,align:0},l=r.instr.value;switch(l){case"type":return t.getType(r.name.value);case"call_indirect":{let m=[p(r.children.shift(),i),0],d=r.children.flatMap(f=>p(f,i));return b(l,m,d)}case"memory.grow":{let m=[0],d=r.children.flatMap(f=>p(f,i));return b(l,m,d)}case"i32.load":case"i64.load":case"f32.load":case"f64.load":case"i32.load8_s":case"i32.load8_u":case"i32.load16_s":case"i32.load16_u":case"i64.load8_s":case"i64.load8_u":case"i64.load16_s":case"i64.load16_u":case"i64.load32_s":case"i64.load32_u":case"i32.store":case"i64.store":case"f32.store":case"f64.store":case"i32.store8":case"i32.store16":case"i64.store8":case"i64.store16":case"i64.store32":{a.align=C[l];for(let f of r.params)a[f.param.value]=o(f.value);let m=[Math.log2(a.align),a.offset].map(f=>{if(typeof f=="number")return x(f);if(typeof f=="bigint")return I(f)}),d=r.children.flatMap(f=>p(f,i));return b(l,m,d)}case"func":{let m={name:r.name?.value??e.funcs.length,params:[],results:[]};e.funcs.push(m);for(let d of r.children)switch(d.instr.value){case"param":m.params.push(...d.children.map(f=>f.instr.value));break;case"result":m.results.push(...d.children.map(f=>f.instr.value));break}return[m.name,m.params,m.results]}case"result":return r.children.flatMap(m=>y.type[m.instr.value]());case"else":case"then":return r.children.flatMap(m=>p(m,i));case"if":{let m=r.name?.value??i.depth.length,d=[],f=[],w;i.depth.push(m);for(let k of r.children)switch(k.instr.value){case"result":d.push(p(k,i));break;case"else":f.push(...y.else());case"then":f.push(p(k,i));break;default:w=p(k,i)}return i.depth.pop(),d.length||d.push(y.type.void()),[...y.if(d.flat(),w),...f.flat(),...y.end()]}case"loop":case"block":{let m=r.name?.value??i.depth.length,d=[],f=[];i.depth.push(m);for(let w of r.children)switch(w.instr.value){case"result":d.push(p(w,i));break;default:f.push(p(w,i))}return i.depth.pop(),d.length||d.push(y.type.void()),[...y[l](),...d.flat().map(w=>[...w]),...f.flat(),...y.end()]}case"br_table":{r.name&&r.params.unshift({param:{value:i.lookup(r.name.value,l)}});let m=r.params.map(f=>o(f.param,i,l)),d=r.children.flatMap(f=>p(f,i));return b(l,[m.length-1,...m],d)}default:{r.name&&r.params.unshift({param:{value:(l.startsWith("global")?e:i).lookup(r.name.value,l)}});let m=r.params.map(f=>o(f.param,i,l)),d=r.children.flatMap(f=>p(f,i));return b(l,m,d)}}}function c(r){switch(r.instr.value){case"module":r.children.forEach(i=>c(i));break;case"memory":{let i=r.name?.value??t.memories.length,a=r.params.map(l=>o(l.param)).flat();if(r.children?.[0]?.instr.value==="export"){let l=r.children[0].params[0].param.value,m=r.children[0].name?.value??0;t.export("memory",m,l)}t.memory(i,...a)}break;case"data":{let i=r.children.shift(),a=r.children.shift().data;t.data(p(i),a)}break;case"start":t.start(r.name.value);break;case"table":{let i=r.params.map(a=>o(a.param));i.unshift(i.pop()),t.table(...i)}break;case"elem":{let i=r.children.shift(),a=r.children.map(l=>l.ref.value);t.elem(p(i),a)}break;case"import":{let i=r.params.map(m=>o(m.param)),a=p(r.children[0]),l=a.shift();t.import("func",l,...i,...a)}break;case"global":{let i={name:r.name?.value??t.globals.length,vartype:"const",type:r.children[0].instr.value};e.globals.push(i),i.type==="mut"&&(i.vartype="var",i.type=r.children[0].children[0].instr.value);let a=r.children[1];t.global(i.name,i.vartype,i.type,p(a))}break;case"type":{let i={name:r.name?.value??t.types.length,params:[],results:[]};e.types.push(i);for(let a of r.children[0].children)switch(a.instr.value){case"param":i.params.push(...a.children.map(l=>l.instr.value));break;case"result":i.results.push(...a.children.map(l=>l.instr.value));break}t.type(i.name,i.params,i.results)}break;case"export":{let i={name:r.params[0].param.value};i.type=r.children[0].instr.value,i.internal_name=r.children[0].name.value,t.export(i.type,i.internal_name,i.name)}break;case"func":{let i={name:r.name?.value??e.funcs.length,context:new _,params:[],results:[],locals:[],body:[]};e.funcs.push(i);for(let a of r.children)switch(a.instr.value){case"export":{let l=a.params[0].param.value;t.export("func",i.name,l)}break;case"local":i.locals.push(...a.children.map(l=>l.instr.value)),i.context.locals.push(...a.children.map(()=>a.name?.value));break;case"param":i.params.push(...a.children.map(l=>l.instr.value)),i.context.locals.push(...a.children.map(()=>a.name?.value));break;case"result":i.results.push(...a.children.map(l=>l.instr.value));break;default:i.body.push(a)}s.push(()=>{t.func(i.name,i.params,i.results,i.locals,[...i.body.flatMap(a=>p(a,i.context))])})}break}}return c(n),s.forEach(r=>r()),t.build()}function F({start:n,peek:t,accept:e,expect:s}){let o=new TextEncoder("utf-8");function _(){let c=[];for(;;){let r=e("string");if(!r)break;if(r.value[0]==="\\"&&r.value[1].match(/[0-9a-f]/i)){let i=r.value.matchAll(/\\([0-9a-f]{1,2})/gi);for(let a of i)c.push(parseInt(a[1],16))}else r.value=r.value.replace(/\\n/,`
`),c.push(...o.encode(r.value))}return c}function*b(){let c;for(;;){if(c=e("number")){c.value=c.value.replace(/_/g,""),yield{param:c};continue}if(c=e("hex")){c.value=c.value.replace(/_/g,""),yield{param:c};continue}if(c=e("string")){yield{param:c};continue}if(c=e("label")){yield{param:c};continue}if(c=e("param")){let r;if(r=e("number")){yield{param:c,value:r};continue}if(r=e("hex")){yield{param:c,value:r};continue}else{yield{param:c};continue}}break}}function p(){let c=e("label");if(c)return{ref:c};if(t("string"))return{data:_()};let r=e("lparen"),i;if(r)i=s("instr");else if(i=e("instr"),!i)return;let a={instr:i,name:e("label"),params:[...b()],children:[]};if(r){let l;for(;!t("eof")&&(l=p());)a.children.push(l);a.params.push(...b()),s("rparen")}else if(i.value==="block"||i.value==="loop"){let l;for(;!t("eof")&&!t("instr","end")&&(l=p());)a.children.push(l);s("instr","end")}return a}return n(),p()}function te(n){return j(F(z("(module "+n+")")))}export{te as default};
