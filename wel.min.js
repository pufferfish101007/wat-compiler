var D=/(?<comment>;;.*|\(;[^]*?;\))|"(?<string>(?:\\"|[^"])*?)"|(?<param>offset|align|shared|funcref)=?|(?<hex>([+-]?nan:)?[+-]?0x[0-9a-f.p+-_]+)|(?<number>[+-]?inf|[+-]?nan|[+-]?\d[\d.e_+-]*)|(?<instr>[a-z][a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)|\$(?<label>[a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)|(?<lparen>\()|(?<rparen>\))|(?<nul>[ \t\n]+)|(?<error>.)/gi;function z(i){let t={},e={},n=i.matchAll(D);function o(){let r=n.next();if(r.done)return{value:{value:null,kind:"eof",index:i.length},done:!0};let[a,l]=Object.entries(r.value.groups).filter(m=>m[1]!=null)[0];return{value:{value:l,kind:a,index:r.value.index},done:!1}}function b(){t=e;do e=o().value;while(e.kind==="nul"||e.kind==="comment");return t}function g(r,a){return r!=null?a!=null?a===e.value:r===e.kind:e}function p(r,a){if(r===e.kind)if(a!=null){if(a===e.value)return b()}else return b();return null}function c(r,a){let l=p(r,a);if(!l)throw new SyntaxError("Unexpected token: "+e.value+`
        expected: `+r+(a?' "'+a+'"':"")+`
    but received: `+e.kind+`
     at position: `+e.index);return l}return{[Symbol.iterator](){return this},next:o,advance:b,peek:g,accept:p,expect:c,start:b}}function*I(i){for(i=R(i);;){let t=Number(i&0x7Fn);if(i>>=7n,i===0n&&(t&64)==0||i===-1n&&(t&64)!=0){yield t;break}yield t|128}}function*A(i){let t=0,e=Math.ceil(Math.log2(Math.abs(i))),n=i<0,o=!0;for(;o;)t=i&127,i=i>>7,n&&(i=i|-(1<<e-7)),i==0&&(t&64)==0||i==-1&&(t&64)==64?o=!1:t=t|128,yield t}function*x(i,t=0){let e=0;do e=i&127,i=i>>7,(i!=0||t>0)&&(e=e|128),yield e,t--;while(i!=0||t>-1)}var v=new DataView(new BigInt64Array(1).buffer);function R(i){return v.setBigInt64(0,i),v.getBigInt64(0)}function*T(i){v.setFloat32(0,i);for(let t=4;t--;)yield v.getUint8(t)}function*B(i){v.setFloat64(0,i);for(let t=8;t--;)yield v.getUint8(t)}function E(i){i=i.toUpperCase();let t=i.indexOf("P"),e,n;t!==-1?(e=i.substring(0,t),n=parseInt(i.substring(t+1))):(e=i,n=0);let o=e.indexOf(".");if(o!==-1){let b=parseInt(e.substring(0,o),16),g=Math.sign(b);b=g*b;let p=e.length-o-1,c=parseInt(e.substring(o+1),16),s=p>0?c/Math.pow(16,p):0;g===0?s===0?e=g:Object.is(g,-0)?e=-s:e=s:e=g*(b+s)}else e=parseInt(e,16);return e*(t!==-1?Math.pow(2,n):1)}var V=2147483648,Y=2139095040;function*q(i){let t=parseInt(i.split("nan:")[1]);t|=Y,i[0]==="-"&&(t|=V),v.setInt32(0,t);for(let e=4;e--;)yield v.getUint8(e)}var J=0x8000000000000000n,W=0x7ff0000000000000n;function*S(i){let t=BigInt(i.split("nan:")[1]);t|=W,i[0]==="-"&&(t|=J),v.setBigInt64(0,t);for(let e=8;e--;)yield v.getUint8(e)}var h={"type.i32":127,"type.i64":126,"type.f32":125,"type.f64":124,"type.void":64,"type.func":96,"type.funcref":112,"section.custom":0,"section.type":1,"section.import":2,"section.function":3,"section.table":4,"section.memory":5,"section.global":6,"section.export":7,"section.start":8,"section.element":9,"section.code":10,"section.data":11,"import.func":0,"import.table":1,"import.memory":2,"import.global":3,"export.function":0,"export.table":1,"export.memory":2,"export.global":3,"global.const":0,"global.var":1,"global.mut":1,"limits.min":0,"limits.minmax":1},H=["unreachable","nop","block","loop","if","else",,,,,,"end","br","br_if","br_table","return","call","call_indirect",,,,,,,,,"drop","select",,,,,"local.get","local.set","local.tee","global.get","global.set",,,,"i32.load","i64.load","f32.load","f64.load","i32.load8_s","i32.load8_u","i32.load16_s","i32.load16_u","i64.load8_s","i64.load8_u","i64.load16_s","i64.load16_u","i64.load32_s","i64.load32_u","i32.store","i64.store","f32.store","f64.store","i32.store8","i32.store16","i64.store8","i64.store16","i64.store32","memory.size","memory.grow","i32.const","i64.const","f32.const","f64.const","i32.eqz","i32.eq","i32.ne","i32.lt_s","i32.lt_u","i32.gt_s","i32.gt_u","i32.le_s","i32.le_u","i32.ge_s","i32.ge_u","i64.eqz","i64.eq","i64.ne","i64.lt_s","i64.lt_u","i64.gt_s","i64.gt_u","i64.le_s","i64.le_u","i64.ge_s","i64.ge_u","f32.eq","f32.ne","f32.lt","f32.gt","f32.le","f32.ge","f64.eq","f64.ne","f64.lt","f64.gt","f64.le","f64.ge","i32.clz","i32.ctz","i32.popcnt","i32.add","i32.sub","i32.mul","i32.div_s","i32.div_u","i32.rem_s","i32.rem_u","i32.and","i32.or","i32.xor","i32.shl","i32.shr_s","i32.shr_u","i32.rotl","i32.rotr","i64.clz","i64.ctz","i64.popcnt","i64.add","i64.sub","i64.mul","i64.div_s","i64.div_u","i64.rem_s","i64.rem_u","i64.and","i64.or","i64.xor","i64.shl","i64.shr_s","i64.shr_u","i64.rotl","i64.rotr","f32.abs","f32.neg","f32.ceil","f32.floor","f32.trunc","f32.nearest","f32.sqrt","f32.add","f32.sub","f32.mul","f32.div","f32.min","f32.max","f32.copysign","f64.abs","f64.neg","f64.ceil","f64.floor","f64.trunc","f64.nearest","f64.sqrt","f64.add","f64.sub","f64.mul","f64.div","f64.min","f64.max","f64.copysign","i32.wrap_i64","i32.trunc_f32_s","i32.trunc_f32_u","i32.trunc_f64_s","i32.trunc_f64_u","i64.extend_i32_s","i64.extend_i32_u","i64.trunc_f32_s","i64.trunc_f32_u","i64.trunc_f64_s","i64.trunc_f64_u","f32.convert_i32_s","f32.convert_i32_u","f32.convert_i64_s","f32.convert_i64_u","f32.demote_f64","f64.convert_i32_s","f64.convert_i32_u","f64.convert_i64_s","f64.convert_i64_u","f64.promote_f32","i32.reinterpret_f32","i64.reinterpret_f64","f32.reinterpret_i32","f64.reinterpret_i64"];for(let[i,t]of H.entries())t!=null&&(h[t]=i);var y={};for(let i in h){y[i]=N(i);let[t,e]=i.split(".");e!=null&&(h[t]=h[t]??{},h[t][e]=h[i],y[t]=y[t]??{},y[t][e]=N(i))}var U={"i32.load":4,"i64.load":8,"f32.load":4,"f64.load":8,"i32.load8_s":1,"i32.load8_u":1,"i32.load16_s":2,"i32.load16_u":2,"i64.load8_s":1,"i64.load8_u":1,"i64.load16_s":2,"i64.load16_u":2,"i64.load32_s":4,"i64.load32_u":4,"i32.store":4,"i64.store":8,"f32.store":4,"f64.store":8,"i32.store8":1,"i32.store16":2,"i64.store8":1,"i64.store16":2,"i64.store32":4};function N(i){return function(t,e){return K(i,t!=null&&!Array.isArray(t)?[t]:t,e!=null&&!Array.isArray(e)?[e]:e)}}var Q={"f64.const":B,"f32.const":T};function*K(i,t=[],e=[]){for(let n of e)switch(typeof n){case"number":yield n;break;default:yield*n;break}yield h[i];for(let n of t)switch(typeof n){case"bigint":yield*I(n);break;case"number":yield*(Q[i]??A)(n);break;default:yield*n}}var X=new TextEncoder("utf-8");function M(i){return[...X.encode(i)]}function G(){return[...M("\0asm"),1,0,0,0]}function u(i,t){return[h.section[i],...x(t.length),...t]}function _(i){return[...x(i.length),...i.flat()]}function Z(i){let t=[],e=[],n;for(let o of i)o!==n&&e.length&&(t.push([...x(e.length),h.type[e[0]]]),e=[]),e.push(o),n=o;return e.length&&t.push([...x(e.length),h.type[e[0]]]),t}function C(i,t){return t!=null?[h.limits.minmax,...x(i),...x(t)]:[h.limits.min,...x(i)]}u.type=function(i){return u("type",_(i.map(([t,e])=>[h.type.func,..._(t.map(n=>h.type[n])),..._(e.map(n=>h.type[n]))])))};u.import=function(i){return u("import",_(i.map(([t,e,n,o])=>[..._(M(t)),..._(M(e)),h.import[n],...o.map(b=>[...x(b)])])))};u.function=function(i){return u("function",_(i.map(t=>[...x(t)])))};u.table=function(i){return u("table",_(i.map(([t,e,n])=>[h.type[t],...C(e,n)])))};u.memory=function(i){return u("memory",_(i.map(([t,e])=>C(t,e))))};u.global=function(i){return u("global",_(i.map(([t,e,n])=>[h.type[e],h.global[t],...n,h.end])))};u.export=function(i){return u("export",_(i.map(([t,e,n])=>[..._(M(t)),h.export[e],...x(n)])))};u.start=function(i){return u("start",[...x(i)])};u.element=function(i){return u("element",_(i.map(([t,e,n])=>[...x(t),...e,h.end,..._(n)])))};u.code=function(i){return u("code",_(i.map(([t,e])=>_([..._(Z(t)),...e,h.end]))))};u.data=function(i){return u("data",_(i.map(([t,e,n])=>[...x(t),...e,h.end,..._(n)])))};var L=class extends Array{log=[];write(t,e){return this.log.push(t,e),this.push(...t),this}get buffer(){return new Uint8Array(this)}},j=class{types=[];imports=[];tables=[];memories=[];globals=[];exports=[];starts="";elements=[];codes=[];datas=[];get funcs(){return this.codes.filter(t=>!t.imported)}ensureType(t,e){let n=[t.join(" "),e.join(" ")].join(),o=this.types.indexOf(n);return o>=0?o:this.types.push(n)-1}getGlobalIndexOf(t){return this.globals.find(e=>e.name===t).idx}getFunc(t){return this.codes.find(e=>e.name===t)}getMemory(t){return this.memories.find(e=>e.name===t)}getType(t){return this.types[t]}type(t,e,n){return this.types[t]=this.ensureType(e,n),this}import(t,e,n,o,b,g){if(t==="func"){let p=this._func(e,b,g,[],[],!1,!0);this.imports.push({mod:n,field:o,type:t,desc:[p.type_idx]})}return this}table(t,e,n){return this.tables.push({type:t,min:e,max:n}),this}memory(t,e,n){return this.memories.push({name:t,min:e,max:n}),this}global(t,e,n,o){let b=this.globals.length;return this.globals.push({idx:b,name:t,valtype:n,mut:e,expr:o}),this}export(t,e,n){return this.exports.push({type:t,name:e,export_name:n}),this}start(t){return this.starts=t,this}elem(t,e){return this.elements.push({offset_idx_expr:t,codes:e}),this}_func(t,e=[],n=[],o=[],b=[],g=!1,p=!1){let c=this.ensureType(e,n),r={idx:this.codes.length,name:t,type_idx:c,locals:o,body:b,imported:p};return this.codes.push(r),g&&this.export("func",t,t),r}func(...t){return this._func(...t),this}data(t,e){return this.datas.push({offset_idx_expr:t,bytes:e}),this}build(){console.time("module build");let t=new L;return t.write(G()),t.write(u.type(this.types.map(e=>e.split(",").map(n=>n.split(" ").filter(Boolean))))),this.imports.length&&t.write(u.import(this.imports.map(e=>[e.mod,e.field,e.type,e.desc]))),t.write(u.function(this.funcs.map(e=>e.type_idx))),this.elements.length&&t.write(u.table(this.tables.map(e=>[e.type,e.min,e.max]))),this.memories.length&&t.write(u.memory(this.memories.map(e=>[e.min,e.max]))),this.globals.length&&t.write(u.global(this.globals.map(e=>[e.mut,e.valtype,e.expr]))),this.exports.length&&t.write(u.export(this.exports.map(e=>e.type==="func"?[e.export_name,e.type,this.getFunc(e.name).idx]:e.type==="memory"?[e.export_name,e.type,this.getMemory(e.name).idx]:[]))),this.starts.length&&t.write(u.start(this.getFunc(this.starts).idx)),this.elements.length&&t.write(u.element(this.elements.map(e=>[0,e.offset_idx_expr,e.codes.map(n=>this.getFunc(n).idx)]))),t.write(u.code(this.funcs.map(e=>[e.locals,e.body]))),this.datas.length&&t.write(u.data(this.datas.map(e=>[0,e.offset_idx_expr,e.bytes]))),console.timeEnd("module build"),t}},P=j;var $=class{globals=[];types=[];funcs=[];lookup(t,e){let n;switch(e){case"call":n=this.funcs.map(o=>o.name).lastIndexOf(t);break;case"type":n=this.types.map(o=>o.name).lastIndexOf(t);break;default:n=this.globals.map(o=>o.name).lastIndexOf(t)}return x(n)}};function O(i){let t=new P,e=new $,n=[];function o(s,r=e,a="i32"){switch(s.kind){case"number":{if(s.value==="inf"||s.value==="+inf")return Infinity;if(s.value==="-inf")return-Infinity;if(s.value==="nan"||s.value==="+nan")return NaN;if(s.value==="-nan")return NaN;if(a?.[0]==="f")return parseFloat(s.value)}case"hex":{let l;return a.indexOf("i64")===0?(s.value[0]==="-"?l=-BigInt(s.value.slice(1)):l=BigInt(s.value),l):a[0]==="f"?(s.value.indexOf("nan")>=0?a.indexOf("f32")===0?l=q(s.value):l=S(s.value):l=E(s.value),l):parseInt(s.value)}case"label":return r.lookup(s.value,a);default:return s.value}}class b{locals=[];depth=[];lookup(r,a){let l;switch(a){case"br":case"br_table":case"br_if":l=this.depth.lastIndexOf(r),~l&&(l=this.depth.length-1-l);break;default:l=this.locals.lastIndexOf(r)}return~l||(l=e.lookup(r,a)),l}}function g(s,r,a){if(!(s in y)||typeof y[s]!="function")throw new Error("Unknown instruction: "+s);return[...y[s](r,a)]}function p(s,r=e){let a={offset:0,align:0},l=s.instr.value;switch(l){case"type":return t.getType(s.name.value);case"call_indirect":{let m=[p(s.children.shift(),r),0],d=s.children.flatMap(f=>p(f,r));return g(l,m,d)}case"memory.grow":{let m=[0],d=s.children.flatMap(f=>p(f,r));return g(l,m,d)}case"i32.load":case"i64.load":case"f32.load":case"f64.load":case"i32.load8_s":case"i32.load8_u":case"i32.load16_s":case"i32.load16_u":case"i64.load8_s":case"i64.load8_u":case"i64.load16_s":case"i64.load16_u":case"i64.load32_s":case"i64.load32_u":case"i32.store":case"i64.store":case"f32.store":case"f64.store":case"i32.store8":case"i32.store16":case"i64.store8":case"i64.store16":case"i64.store32":{a.align=U[l];for(let f of s.params)a[f.param.value]=o(f.value);let m=[Math.log2(a.align),a.offset].map(f=>{if(typeof f=="number")return x(f);if(typeof f=="bigint")return I(f)}),d=s.children.flatMap(f=>p(f,r));return g(l,m,d)}case"func":{let m={name:s.name?.value??e.funcs.length,params:[],results:[]};e.funcs.push(m);for(let d of s.children)switch(d.instr.value){case"param":m.params.push(...d.children.map(f=>f.instr.value));break;case"result":m.results.push(...d.children.map(f=>f.instr.value));break}return[m.name,m.params,m.results]}case"result":return s.children.flatMap(m=>y.type[m.instr.value]());case"else":case"then":return s.children.flatMap(m=>p(m,r));case"if":{let m=s.name?.value??r.depth.length,d=[],f=[],w;r.depth.push(m);for(let k of s.children)switch(k.instr.value){case"result":d.push(p(k,r));break;case"else":f.push(...y.else());case"then":f.push(p(k,r));break;default:w=p(k,r)}return r.depth.pop(),d.length||d.push(y.type.void()),[...y.if(d.flat(),w),...f.flat(),...y.end()]}case"loop":case"block":{let m=s.name?.value??r.depth.length,d=[],f=[];r.depth.push(m);for(let w of s.children)switch(w.instr.value){case"result":d.push(p(w,r));break;default:f.push(p(w,r))}return r.depth.pop(),d.length||d.push(y.type.void()),[...y[l](),...d.flat().map(w=>[...w]),...f.flat(),...y.end()]}case"br_table":{s.name&&s.params.unshift({param:{value:r.lookup(s.name.value,l)}});let m=s.params.map(f=>o(f.param,r,l)),d=s.children.flatMap(f=>p(f,r));return g(l,[m.length-1,...m],d)}default:{s.name&&s.params.unshift({param:{value:(l.startsWith("global")?e:r).lookup(s.name.value,l)}});let m=s.params.map(f=>o(f.param,r,l)),d=s.children.flatMap(f=>p(f,r));return g(l,m,d)}}}function c(s){switch(s.instr.value){case"module":s.children.forEach(r=>c(r));break;case"memory":{let r=s.name?.value??t.memories.length,a=s.params.map(l=>o(l.param)).flat();if(s.children?.[0]?.instr.value==="export"){let l=s.children[0].params[0].param.value,m=s.children[0].name?.value??0;t.export("memory",m,l)}t.memory(r,...a)}break;case"data":{let r=s.children.shift(),a=s.children.shift().data;t.data(p(r),a)}break;case"start":t.start(s.name.value);break;case"table":{let r=s.params.map(a=>o(a.param));r.unshift(r.pop()),t.table(...r)}break;case"elem":{let r=s.children.shift(),a=s.children.map(l=>l.ref.value);t.elem(p(r),a)}break;case"import":{let r=s.params.map(m=>o(m.param)),a=p(s.children[0]),l=a.shift();t.import("func",l,...r,...a)}break;case"global":{let r={name:s.name?.value??t.globals.length,vartype:"const",type:s.children[0].instr.value};e.globals.push(r),r.type==="mut"&&(r.vartype="var",r.type=s.children[0].children[0].instr.value);let a=s.children[1];t.global(r.name,r.vartype,r.type,p(a))}break;case"type":{let r={name:s.name?.value??t.types.length,params:[],results:[]};e.types.push(r);for(let a of s.children[0].children)switch(a.instr.value){case"param":r.params.push(...a.children.map(l=>l.instr.value));break;case"result":r.results.push(...a.children.map(l=>l.instr.value));break}t.type(r.name,r.params,r.results)}break;case"export":{let r={name:s.params[0].param.value};r.type=s.children[0].instr.value,r.internal_name=s.children[0].name.value,t.export(r.type,r.internal_name,r.name)}break;case"func":{let r={name:s.name?.value??e.funcs.length,context:new b,params:[],results:[],locals:[],body:[]};e.funcs.push(r);for(let a of s.children)switch(a.instr.value){case"export":{let l=a.params[0].param.value;t.export("func",r.name,l)}break;case"local":r.locals.push(...a.children.map(l=>l.instr.value)),r.context.locals.push(...a.children.map(()=>a.name?.value));break;case"param":r.params.push(...a.children.map(l=>l.instr.value)),r.context.locals.push(...a.children.map(()=>a.name?.value));break;case"result":r.results.push(...a.children.map(l=>l.instr.value));break;default:r.body.push(a)}n.push(()=>{t.func(r.name,r.params,r.results,r.locals,[...r.body.flatMap(a=>p(a,r.context))])})}break}}return c(i),n.forEach(s=>s()),t.build()}function F({start:i,peek:t,accept:e,expect:n}){let o=new TextEncoder("utf-8");function b(){let c=[];for(;;){let s=e("string");if(!s)break;if(s.value[0]==="\\"){let r=s.value.matchAll(/\\([0-9a-f]{1,2})/gi);for(let a of r)c.push(parseInt(a[1],16))}else c.push(...o.encode(s.value))}return c}function*g(){let c;for(;;){if(c=e("number")){c.value=c.value.replace(/_/g,""),yield{param:c};continue}if(c=e("hex")){c.value=c.value.replace(/_/g,""),yield{param:c};continue}if(c=e("string")){yield{param:c};continue}if(c=e("label")){yield{param:c};continue}if(c=e("param")){let s;if(s=e("number")){yield{param:c,value:s};continue}if(s=e("hex")){yield{param:c,value:s};continue}else{yield{param:c};continue}}break}}function p(){let c=e("label");if(c)return{ref:c};if(t("string"))return{data:b()};let s=e("lparen"),r;if(s)r=n("instr");else if(r=e("instr"),!r)return;let a={instr:r,name:e("label"),params:[...g()],children:[]};if(s){let l;for(;!t("eof")&&(l=p());)a.children.push(l);a.params.push(...g()),n("rparen")}else if(r.value==="block"||r.value==="loop"){let l;for(;!t("eof")&&!t("instr","end")&&(l=p());)a.children.push(l);n("instr","end")}return a}return i(),p()}function ee(i){return O(F(z("(module "+i+")"))).build()}export{ee as default};
