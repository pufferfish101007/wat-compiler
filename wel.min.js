var C=/(?<comment>;;.*|\(;[^]*?;\))|"(?<string>(?:\\"|[^"])*?)"|(?<param>offset|align|shared|funcref)=?|(?<hex>(nan:)?[+-]?0x[0-9a-f.p+-_]+)|(?<number>[+-]?inf|nan|[+-]?\d[\d.e_+-]*)|(?<instr>[a-z][a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)|\$(?<label>[a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)|(?<lparen>\()|(?<rparen>\))|(?<nul>[ \t\n]+)|(?<error>.)/gi;function A(n){let e={},t={},a=n.matchAll(C);function o(){let r=a.next();if(r.done)return{value:{value:null,kind:"eof",index:n.length},done:!0};let[s,l]=Object.entries(r.value.groups).filter(f=>f[1]!=null)[0];return{value:{value:l,kind:s,index:r.value.index},done:!1}}function b(){e=t;do t=o().value;while(t.kind==="nul"||t.kind==="comment");return e}function x(r,s){return r!=null?s!=null?s===t.value:r===t.kind:t}function m(r,s){if(r===t.kind)if(s!=null){if(s===t.value)return b()}else return b();return null}function p(r,s){let l=m(r,s);if(!l)throw new SyntaxError("Unexpected token: "+t.value+`
        expected: `+r+(s?' "'+s+'"':"")+`
    but received: `+t.kind+`
     at position: `+t.index);return l}return{[Symbol.iterator](){return this},next:o,advance:b,peek:x,accept:m,expect:p,start:b}}function*k(n){for(;;){let e=Number(n&0x7Fn);if(n>>=7n,n===0n&&(e&64)==0||n===-1n&&(e&64)!=0){yield e;break}yield e|128}}function*E(n){let e=0,t=Math.ceil(Math.log2(Math.abs(n))),a=n<0,o=!0;for(;o;)e=n&127,n=n>>7,a&&(n=n|-(1<<t-7)),n==0&&(e&64)==0||n==-1&&(e&64)==64?o=!1:e=e|128,yield e}function*y(n,e=0){let t=0;do t=n&127,n=n>>7,(n!=0||e>0)&&(t=t|128),yield t,e--;while(n!=0||e>-1)}var j=new DataView(new Float64Array(1).buffer);function*O(n){j.setFloat32(0,n);for(let e=4;e--;)yield j.getUint8(e)}function*q(n){j.setFloat64(0,n);for(let e=8;e--;)yield j.getUint8(e)}var h={"type.i32":127,"type.i64":126,"type.f32":125,"type.f64":124,"type.void":64,"type.func":96,"type.funcref":112,"section.custom":0,"section.type":1,"section.import":2,"section.function":3,"section.table":4,"section.memory":5,"section.global":6,"section.export":7,"section.start":8,"section.element":9,"section.code":10,"section.data":11,"import.func":0,"import.table":1,"import.memory":2,"import.global":3,"export.function":0,"export.table":1,"export.memory":2,"export.global":3,"global.const":0,"global.var":1,"global.mut":1,"limits.min":0,"limits.minmax":1},D=["unreachable","nop","block","loop","if","else",,,,,,"end","br","br_if","br_table","return","call","call_indirect",,,,,,,,,"drop","select",,,,,"local.get","local.set","local.tee","global.get","global.set",,,,"i32.load","i64.load","f32.load","f64.load","i32.load8_s","i32.load8_u","i32.load16_s","i32.load16_u","i64.load8_s","i64.load8_u","i64.load16_s","i64.load16_u","i64.load32_s","i64.load32_u","i32.store","i64.store","f32.store","f64.store","i32.store8","i32.store16","i64.store8","i64.store16","i64.store32","memory.size","memory.grow","i32.const","i64.const","f32.const","f64.const","i32.eqz","i32.eq","i32.ne","i32.lt_s","i32.lt_u","i32.gt_s","i32.gt_u","i32.le_s","i32.le_u","i32.ge_s","i32.ge_u","i64.eqz","i64.eq","i64.ne","i64.lt_s","i64.lt_u","i64.gt_s","i64.gt_u","i64.le_s","i64.le_u","i64.ge_s","i64.ge_u","f32.eq","f32.ne","f32.lt","f32.gt","f32.le","f32.ge","f64.eq","f64.ne","f64.lt","f64.gt","f64.le","f64.ge","i32.clz","i32.ctz","i32.popcnt","i32.add","i32.sub","i32.mul","i32.div_s","i32.div_u","i32.rem_s","i32.rem_u","i32.and","i32.or","i32.xor","i32.shl","i32.shr_s","i32.shr_u","i32.rotl","i32.rotr","i64.clz","i64.ctz","i64.popcnt","i64.add","i64.sub","i64.mul","i64.div_s","i64.div_u","i64.rem_s","i64.rem_u","i64.and","i64.or","i64.xor","i64.shl","i64.shr_s","i64.shr_u","i64.rotl","i64.rotr","f32.abs","f32.neg","f32.ceil","f32.floor","f32.trunc","f32.nearest","f32.sqrt","f32.add","f32.sub","f32.mul","f32.div","f32.min","f32.max","f32.copysign","f64.abs","f64.neg","f64.ceil","f64.floor","f64.trunc","f64.nearest","f64.sqrt","f64.add","f64.sub","f64.mul","f64.div","f64.min","f64.max","f64.copysign","i32.wrap_i64","i32.trunc_f32_s","i32.trunc_f32_u","i32.trunc_f64_s","i32.trunc_f64_u","i64.extend_i32_s","i64.extend_i32_u","i64.trunc_f32_s","i64.trunc_f32_u","i64.trunc_f64_s","i64.trunc_f64_u","f32.convert_i32_s","f32.convert_i32_u","f32.convert_i64_s","f32.convert_i64_u","f32.demote_f64","f64.convert_i32_s","f64.convert_i32_u","f64.convert_i64_s","f64.convert_i64_u","f64.promote_f32","i32.reinterpret_f32","i64.reinterpret_f64","f32.reinterpret_i32","f64.reinterpret_i64"];for(let[n,e]of D.entries())e!=null&&(h[e]=n);var _={};for(let n in h){_[n]=M(n);let[e,t]=n.split(".");t!=null&&(h[e]=h[e]??{},h[e][t]=h[n],_[e]=_[e]??{},_[e][t]=M(n))}function M(n){return function(e,t){return R(n,e!=null&&!Array.isArray(e)?[e]:e,t!=null&&!Array.isArray(t)?[t]:t)}}var V={"f64.const":q,"f32.const":O};function*R(n,e=[],t=[]){for(let a of t)switch(typeof a){case"number":yield a;break;default:yield*a;break}yield h[n];for(let a of e)switch(typeof a){case"bigint":yield*k(a);break;case"number":yield*(V[n]??E)(a);break;default:yield*a}}var Y=new TextEncoder("utf-8");function z(n){return[...Y.encode(n)]}function N(){return[...z("\0asm"),1,0,0,0]}function u(n,e){return[h.section[n],...y(e.length),...e]}function g(n){return[...y(n.length),...n.flat()]}function G(n){let e=[],t=[],a;for(let o of n)o!==a&&t.length&&(e.push([...y(t.length),h.type[t[0]]]),t=[]),t.push(o),a=o;return t.length&&e.push([...y(t.length),h.type[t[0]]]),e}function S(n,e){return e!=null?[h.limits.minmax,...y(n),...y(e)]:[h.limits.min,...y(n)]}u.type=function(n){return u("type",g(n.map(([e,t])=>[h.type.func,...g(e.map(a=>h.type[a])),...g(t.map(a=>h.type[a]))])))};u.import=function(n){return u("import",g(n.map(([e,t,a,o])=>[...g(z(e)),...g(z(t)),h.import[a],...o.map(b=>[...y(b)])])))};u.function=function(n){return u("function",g(n.map(e=>[...y(e)])))};u.table=function(n){return u("table",g(n.map(([e,t,a])=>[h.type[e],...S(t,a)])))};u.memory=function(n){return u("memory",g(n.map(([e,t])=>S(e,t))))};u.global=function(n){return u("global",g(n.map(([e,t,a])=>[h.type[t],h.global[e],...a,h.end])))};u.export=function(n){return u("export",g(n.map(([e,t,a])=>[...g(z(e)),h.export[t],...y(a)])))};u.start=function(n){return u("start",[...y(n)])};u.element=function(n){return u("element",g(n.map(([e,t,a])=>[...y(e),...t,h.end,...g(a)])))};u.code=function(n){return u("code",g(n.map(([e,t])=>g([...g(G(e)),...t,h.end]))))};u.data=function(n){return u("data",g(n.map(([e,t,a])=>[...y(e),...t,h.end,...g(a)])))};var U=class extends Array{log=[];write(e,t){return this.log.push(e,t),this.push(...e),this}get buffer(){return new Uint8Array(this)}},I=class{types=[];imports=[];tables=[];memories=[];globals=[];exports=[];starts="";elements=[];codes=[];datas=[];get funcs(){return this.codes.filter(e=>!e.imported)}ensureType(e,t){let a=[e.join(" "),t.join(" ")].join(),o=this.types.indexOf(a);return o>=0?o:this.types.push(a)-1}getGlobalIndexOf(e){return this.globals.find(t=>t.name===e).idx}getFunc(e){return this.codes.find(t=>t.name===e)}getMemory(e){return this.memories.find(t=>t.name===e)}getType(e){return this.types[e]}type(e,t,a){return this.types[e]=this.ensureType(t,a),this}import(e,t,a,o,b,x){if(e==="func"){let m=this._func(t,b,x,[],[],!1,!0);this.imports.push({mod:a,field:o,type:e,desc:[m.type_idx]})}return this}table(e,t,a){return this.tables.push({type:e,min:t,max:a}),this}memory(e,t,a){return this.memories.push({name:e,min:t,max:a}),this}global(e,t,a,o){let b=this.globals.length;return this.globals.push({idx:b,name:e,valtype:a,mut:t,expr:o}),this}export(e,t,a){return this.exports.push({type:e,name:t,export_name:a}),this}start(e){return this.starts=e,this}elem(e,t){return this.elements.push({offset_idx_expr:e,codes:t}),this}_func(e,t=[],a=[],o=[],b=[],x=!1,m=!1){let p=this.ensureType(t,a),r={idx:this.codes.length,name:e,type_idx:p,locals:o,body:b,imported:m};return this.codes.push(r),x&&this.export("func",e,e),r}func(...e){return this._func(...e),this}data(e,t){return this.datas.push({offset_idx_expr:e,bytes:t}),this}build(){console.time("module build");let e=new U;return e.write(N()),e.write(u.type(this.types.map(t=>t.split(",").map(a=>a.split(" ").filter(Boolean))))),this.imports.length&&e.write(u.import(this.imports.map(t=>[t.mod,t.field,t.type,t.desc]))),e.write(u.function(this.funcs.map(t=>t.type_idx))),this.elements.length&&e.write(u.table(this.tables.map(t=>[t.type,t.min,t.max]))),this.memories.length&&e.write(u.memory(this.memories.map(t=>[t.min,t.max]))),this.globals.length&&e.write(u.global(this.globals.map(t=>[t.mut,t.valtype,t.expr]))),this.exports.length&&e.write(u.export(this.exports.map(t=>t.type==="func"?[t.export_name,t.type,this.getFunc(t.name).idx]:t.type==="memory"?[t.export_name,t.type,this.getMemory(t.name).idx]:[]))),this.starts.length&&e.write(u.start(this.getFunc(this.starts).idx)),this.elements.length&&e.write(u.element(this.elements.map(t=>[0,t.offset_idx_expr,t.codes.map(a=>this.getFunc(a).idx)]))),e.write(u.code(this.funcs.map(t=>[t.locals,t.body]))),this.datas.length&&e.write(u.data(this.datas.map(t=>[0,t.offset_idx_expr,t.bytes]))),console.timeEnd("module build"),e}},B=I;var $=class{globals=[];types=[];funcs=[];lookup(e,t){let a;switch(t){case"call":a=this.funcs.map(o=>o.name).lastIndexOf(e);break;case"type":a=this.types.map(o=>o.name).lastIndexOf(e);break;default:a=this.globals.map(o=>o.name).lastIndexOf(e)}return a===-1&&console.log(e,t),a}};function F(n){let e=new B,t=new $,a=[];function o(i,r){switch(i.kind){case"number":return i.value==="inf"?Infinity:i.value==="nan"?NaN:parseFloat(i.value);case"hex":return i.value.length>10?BigInt(i.value):parseInt(i.value);case"label":return r.lookup(i.value);default:return i.value}}class b{locals=[];depth=[];lookup(r,s){let l=this.locals.lastIndexOf(r);return~l||(l=this.depth.lastIndexOf(r),~l&&(l=this.depth.length-1-l)),~l||(l=t.lookup(r,s)),l}}function x(i,r,s){if(!(i in _)||typeof _[i]!="function")throw new Error("Unknown instruction: "+i);return[..._[i](r,s)]}function m(i,r=t){let s={offset:0,align:0},l=i.instr.value;switch(l){case"type":return e.getType(i.name.value);case"call_indirect":{let f=[m(i.children.shift(),r),0],d=i.children.flatMap(c=>m(c,r));return x(l,f,d)}case"memory.grow":{let f=[0],d=i.children.flatMap(c=>m(c,r));return x(l,f,d)}case"f32.store":l==="f32.store"&&(s.align=4);case"i64.store":l==="i64.store"&&(s.align=4);case"i32.store":l==="i32.store"&&(s.align=4);case"i32.store8":l==="i32.store8"&&(s.align=0);case"i32.store16":l==="i32.store16"&&(s.align=2);case"f32.load":l==="f32.load"&&(s.align=4);case"i32.load":l==="i32.load"&&(s.align=4);case"i32.load16_s":l==="i32.load16_s"&&(s.align=2);case"i32.load16_u":l==="i32.load16_u"&&(s.align=2);case"i32.load8_s":l==="i32.load8_s"&&(s.align=0);case"i32.load8_u":{l==="i32.load8_u"&&(s.align=0);for(let c of i.params)s[c.param.value]=o(c.value);let f=[s.align/2,s.offset].map(c=>{if(typeof c=="number")return y(c);if(typeof c=="bigint")return k(c)}),d=i.children.flatMap(c=>m(c,r));return x(l,f,d)}case"func":{let f={name:i.name?.value??t.funcs.length,params:[],results:[]};t.funcs.push(f);for(let d of i.children)switch(d.instr.value){case"param":f.params.push(...d.children.map(c=>c.instr.value));break;case"result":f.results.push(...d.children.map(c=>c.instr.value));break}return[f.name,f.params,f.results]}case"result":return i.children.flatMap(f=>_.type[f.instr.value]());case"else":case"then":return i.children.flatMap(f=>m(f,r));case"if":{let f=i.name?.value??r.depth.length,d=[],c=[],v;r.depth.push(f);for(let w of i.children)switch(w.instr.value){case"result":d.push(m(w,r));break;case"else":c.push(..._.else());case"then":c.push(m(w,r));break;default:v=m(w,r)}return r.depth.pop(),d.length||d.push(_.type.void()),[..._.if(d.flat(),v),...c.flat(),..._.end()]}case"loop":case"block":{let f=i.name?.value??r.depth.length,d=[],c=[];r.depth.push(f);for(let v of i.children)switch(v.instr.value){case"result":d.push(m(v,r));break;default:c.push(m(v,r))}return r.depth.pop(),d.length||d.push(_.type.void()),[..._[l](),...d.flat().map(v=>[...v]),...c.flat(),..._.end()]}case"br_table":{i.name&&i.params.unshift({param:{value:r.lookup(i.name.value)}});let f=i.params.map(c=>o(c.param,r)),d=i.children.flatMap(c=>m(c,r));return x(l,[f.length-1,...f],d)}default:{i.name&&i.params.unshift({param:{value:(l.startsWith("global")?t:r).lookup(i.name.value,l)}});let f=i.params.map(c=>o(c.param)),d=i.children.flatMap(c=>m(c,r));return x(l,f,d)}}}function p(i){switch(i.instr.value){case"module":i.children.forEach(r=>p(r));break;case"memory":{let r=i.name?.value??e.memories.length,s=i.params.map(l=>o(l.param)).flat();if(i.children?.[0]?.instr.value==="export"){let l=i.children[0].params[0].param.value,f=i.children[0].name?.value??0;e.export("memory",f,l)}e.memory(r,...s)}break;case"data":{let r=i.children.shift(),s=i.children.shift().data;e.data(m(r),s)}break;case"start":e.start(i.name.value);break;case"table":{let r=i.params.map(s=>o(s.param));r.unshift(r.pop()),e.table(...r)}break;case"elem":{let r=i.children.shift(),s=i.children.map(l=>l.ref.value);e.elem(m(r),s)}break;case"import":{let r=i.params.map(f=>o(f.param)),s=m(i.children[0]),l=s.shift();e.import("func",l,...r,...s)}break;case"global":{let r={name:i.name?.value??e.globals.length,vartype:"const",type:i.children[0].instr.value};t.globals.push(r),r.type==="mut"&&(r.vartype="var",r.type=i.children[0].children[0].instr.value);let s=i.children[1];e.global(r.name,r.vartype,r.type,m(s))}break;case"type":{let r={name:i.name?.value??e.types.length,params:[],results:[]};t.types.push(r);for(let s of i.children[0].children)switch(s.instr.value){case"param":r.params.push(...s.children.map(l=>l.instr.value));break;case"result":r.results.push(...s.children.map(l=>l.instr.value));break}e.type(r.name,r.params,r.results)}break;case"export":{let r={name:i.params[0].param.value};r.type=i.children[0].instr.value,r.internal_name=i.children[0].name.value,e.export(r.type,r.internal_name,r.name)}break;case"func":{let r={name:i.name?.value??t.funcs.length,context:new b,params:[],results:[],locals:[],body:[]};t.funcs.push(r);for(let s of i.children)switch(s.instr.value){case"export":{let l=s.params[0].param.value;e.export("func",r.name,l)}break;case"local":r.locals.push(...s.children.map(l=>l.instr.value)),r.context.locals.push(...s.children.map(()=>s.name?.value));break;case"param":r.params.push(...s.children.map(l=>l.instr.value)),r.context.locals.push(...s.children.map(()=>s.name?.value));break;case"result":r.results.push(...s.children.map(l=>l.instr.value));break;default:r.body.push(s)}a.push(()=>{e.func(r.name,r.params,r.results,r.locals,[...r.body.flatMap(s=>m(s,r.context))])})}break}}return p(n),a.forEach(i=>i()),e.build()}function T({start:n,peek:e,accept:t,expect:a}){let o=new TextEncoder("utf-8");function b(){let p=[];for(;;){let i=t("string");if(!i)break;if(i.value[0]==="\\"){let r=i.value.matchAll(/\\([0-9a-f]{1,2})/gi);for(let s of r)p.push(parseInt(s[1],16))}else p.push(...o.encode(i.value))}return p}function*x(){let p;for(;;){if(p=t("number")){p.value=p.value.replace(/_/g,""),yield{param:p};continue}if(p=t("hex")){p.value=p.value.replace(/_/g,""),yield{param:p};continue}if(p=t("string")){yield{param:p};continue}if(p=t("label")){yield{param:p};continue}if(p=t("param")){let i;if(i=t("number")){yield{param:p,value:i};continue}if(i=t("hex")){yield{param:p,value:i};continue}else{yield{param:p};continue}}break}}function m(){let p=t("label");if(p)return{ref:p};if(e("string"))return{data:b()};let i=t("lparen"),r;if(i)r=a("instr");else if(r=t("instr"),!r)return;let s={instr:r,name:t("label"),params:[...x()],children:[]};if(i){let l;for(;!e("eof")&&(l=m());)s.children.push(l);s.params.push(...x()),a("rparen")}else if(r.value==="block"||r.value==="loop"){let l;for(;!e("eof")&&!e("instr","end")&&(l=m());)s.children.push(l);a("instr","end")}return s}return n(),m()}function J(n){return F(T(A("(module "+n+")"))).build()}export{J as default};
