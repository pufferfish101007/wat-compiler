var D=new RegExp([/(?<comment>;;.*|\(;[^]*?;\))/,/"(?<string>(?:\\"|[^"])*?)"/,/(?<param>offset|align|shared|funcref)=?/,/(?<hex>([+-]?nan:)?[+-]?0x[0-9a-f.p+-_]+)/,/(?<number>[+-]?inf|[+-]?nan|[+-]?\d[\d.e_+-]*)/,/(?<instr>[a-z][a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)/,/\$(?<label>[a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)/,/(?<lparen>\()|(?<rparen>\))|(?<nul>[ \t\n]+)|(?<error>.)/].map(r=>r.toString().slice(1,-1)).join("|"),"gi");function A(r){let e={},t={},s=r.matchAll(D);function o(){let i=s.next();if(i.done)return{value:{value:null,kind:"eof",index:r.length},done:!0};let[a,l]=Object.entries(i.value.groups).filter(c=>c[1]!=null)[0];return{value:{value:l,kind:a,index:i.value.index},done:!1}}function _(){e=t;do t=o().value;while(t.kind==="nul"||t.kind==="comment");return e}function g(i,a){return i!=null?a!=null?a===t.value:i===t.kind:t}function m(i,a){if(i===t.kind)if(a!=null){if(a===t.value)return _()}else return _();return null}function f(i,a){let l=m(i,a);if(!l)throw new SyntaxError("Unexpected token: "+t.value+`
        expected: `+i+(a?' "'+a+'"':"")+`
    but received: `+t.kind+`
     at position: `+t.index);return l}return{[Symbol.iterator](){return this},next:o,advance:_,peek:g,accept:m,expect:f,start:_}}function N({start:r,peek:e,accept:t,expect:s}){let o=new TextEncoder("utf-8");function _(){let f=[];for(;;){let n=t("string");if(!n)break;if(n.value[0]==="\\"&&n.value[1].match(/[0-9a-f]/i)){let i=n.value.matchAll(/\\([0-9a-f]{1,2})/gi);for(let a of i)f.push(parseInt(a[1],16))}else n.value=n.value.replace(/\\n/,`
`),f.push(...o.encode(n.value))}return f}function*g(){let f;for(;;){if(f=t("number")){f.value=f.value.replace(/_/g,""),yield{param:f};continue}if(f=t("hex")){f.value=f.value.replace(/_/g,""),yield{param:f};continue}if(f=t("string")){yield{param:f};continue}if(f=t("label")){yield{param:f};continue}if(f=t("param")){let n;if(n=t("number")){yield{param:f,value:n};continue}if(n=t("hex")){yield{param:f,value:n};continue}else{yield{param:f};continue}}break}}function m(){let f=t("label");if(f)return{ref:f};if(e("string"))return{data:_()};let n=t("lparen"),i;if(n)i=s("instr");else if(i=t("instr"),!i)return;let a={instr:i,name:t("label"),params:[...g()],children:[]};if(n){let l;for(;!e("eof")&&(l=m());)a.children.push(l);a.params.push(...g()),s("rparen")}else if(i.value==="block"||i.value==="loop"){let l;for(;!e("eof")&&!e("instr","end")&&(l=m());)a.children.push(l);s("instr","end")}return a}return r(),m()}function*I(r){for(r=V(r);;){let e=Number(r&0x7Fn);if(r>>=7n,r===0n&&(e&64)==0||r===-1n&&(e&64)!=0){yield e;break}yield e|128}}function*B(r){let e=0,t=Math.ceil(Math.log2(Math.abs(r))),s=r<0,o=!0;for(;o;)e=r&127,r=r>>7,s&&(r=r|-(1<<t-7)),r==0&&(e&64)==0||r==-1&&(e&64)==64?o=!1:e=e|128,yield e}function*b(r,e=0){let t=0;do t=r&127,r=r>>7,(r!=0||e>0)&&(t=t|128),yield t,e--;while(r!=0||e>-1)}var v=new DataView(new BigInt64Array(1).buffer);function V(r){return v.setBigInt64(0,r),v.getBigInt64(0)}function*T(r){v.setFloat32(0,r);for(let e=4;e--;)yield v.getUint8(e)}function*E(r){v.setFloat64(0,r);for(let e=8;e--;)yield v.getUint8(e)}function S(r){r=r.toUpperCase();let e=r.indexOf("P"),t,s;e!==-1?(t=r.substring(0,e),s=parseInt(r.substring(e+1))):(t=r,s=0);let o=t.indexOf(".");if(o!==-1){let _=parseInt(t.substring(0,o),16),g=Math.sign(_);_=g*_;let m=t.length-o-1,f=parseInt(t.substring(o+1),16),n=m>0?f/Math.pow(16,m):0;g===0?n===0?t=g:Object.is(g,-0)?t=-n:t=n:t=g*(_+n)}else t=parseInt(t,16);return t*(e!==-1?Math.pow(2,s):1)}var Y=2147483648,J=2139095040;function*q(r){let e=parseInt(r.split("nan:")[1]);e|=J,r[0]==="-"&&(e|=Y),v.setInt32(0,e);for(let t=4;t--;)yield v.getUint8(t)}var W=0x8000000000000000n,H=0x7ff0000000000000n;function*U(r){let e=BigInt(r.split("nan:")[1]);e|=H,r[0]==="-"&&(e|=W),v.setBigInt64(0,e);for(let t=8;t--;)yield v.getUint8(t)}var d={"type.i32":127,"type.i64":126,"type.f32":125,"type.f64":124,"type.void":64,"type.func":96,"type.funcref":112,"section.custom":0,"section.type":1,"section.import":2,"section.function":3,"section.table":4,"section.memory":5,"section.global":6,"section.export":7,"section.start":8,"section.element":9,"section.code":10,"section.data":11,"import.func":0,"import.table":1,"import.memory":2,"import.global":3,"export.function":0,"export.table":1,"export.memory":2,"export.global":3,"global.const":0,"global.var":1,"global.mut":1,"limits.min":0,"limits.minmax":1,"limits.shared":3},G=["unreachable","nop","block","loop","if","else",,,,,,"end","br","br_if","br_table","return","call","call_indirect",,,,,,,,,"drop","select",,,,,"local.get","local.set","local.tee","global.get","global.set",,,,"i32.load","i64.load","f32.load","f64.load","i32.load8_s","i32.load8_u","i32.load16_s","i32.load16_u","i64.load8_s","i64.load8_u","i64.load16_s","i64.load16_u","i64.load32_s","i64.load32_u","i32.store","i64.store","f32.store","f64.store","i32.store8","i32.store16","i64.store8","i64.store16","i64.store32","memory.size","memory.grow","i32.const","i64.const","f32.const","f64.const","i32.eqz","i32.eq","i32.ne","i32.lt_s","i32.lt_u","i32.gt_s","i32.gt_u","i32.le_s","i32.le_u","i32.ge_s","i32.ge_u","i64.eqz","i64.eq","i64.ne","i64.lt_s","i64.lt_u","i64.gt_s","i64.gt_u","i64.le_s","i64.le_u","i64.ge_s","i64.ge_u","f32.eq","f32.ne","f32.lt","f32.gt","f32.le","f32.ge","f64.eq","f64.ne","f64.lt","f64.gt","f64.le","f64.ge","i32.clz","i32.ctz","i32.popcnt","i32.add","i32.sub","i32.mul","i32.div_s","i32.div_u","i32.rem_s","i32.rem_u","i32.and","i32.or","i32.xor","i32.shl","i32.shr_s","i32.shr_u","i32.rotl","i32.rotr","i64.clz","i64.ctz","i64.popcnt","i64.add","i64.sub","i64.mul","i64.div_s","i64.div_u","i64.rem_s","i64.rem_u","i64.and","i64.or","i64.xor","i64.shl","i64.shr_s","i64.shr_u","i64.rotl","i64.rotr","f32.abs","f32.neg","f32.ceil","f32.floor","f32.trunc","f32.nearest","f32.sqrt","f32.add","f32.sub","f32.mul","f32.div","f32.min","f32.max","f32.copysign","f64.abs","f64.neg","f64.ceil","f64.floor","f64.trunc","f64.nearest","f64.sqrt","f64.add","f64.sub","f64.mul","f64.div","f64.min","f64.max","f64.copysign","i32.wrap_i64","i32.trunc_f32_s","i32.trunc_f32_u","i32.trunc_f64_s","i32.trunc_f64_u","i64.extend_i32_s","i64.extend_i32_u","i64.trunc_f32_s","i64.trunc_f32_u","i64.trunc_f64_s","i64.trunc_f64_u","f32.convert_i32_s","f32.convert_i32_u","f32.convert_i64_s","f32.convert_i64_u","f32.demote_f64","f64.convert_i32_s","f64.convert_i32_u","f64.convert_i64_s","f64.convert_i64_u","f64.promote_f32","i32.reinterpret_f32","i64.reinterpret_f64","f32.reinterpret_i32","f64.reinterpret_i64"],C={get_local:"local.get",set_local:"local.set",tee_local:"local.tee",get_global:"global.get",set_global:"global.set","i32.trunc_s/f32":"i32.trunc_f32_s","i32.trunc_u/f32":"i32.trunc_f32_u","i32.trunc_s/f64":"i32.trunc_f64_s","i32.trunc_u/f64":"i32.trunc_f64_u","i64.extend_s/i32":"i64.extend_i32_s","i64.extend_u/i32":"i64.extend_i32_u","i64.trunc_s/f32":"i64.trunc_f32_s","i64.trunc_u/f32":"i64.trunc_f32_u","i64.trunc_s/f64":"i64.trunc_f64_s","i64.trunc_u/f64":"i64.trunc_f64_u","f32.convert_s/i32":"f32.convert_i32_s","f32.convert_u/i32":"f32.convert_i32_u","f32.convert_s/i64":"f32.convert_i64_s","f32.convert_u/i64":"f32.convert_i64_u","f32.demote/f64":"f32.demote_f64","f64.convert_s/i32":"f64.convert_i32_s","f64.convert_u/i32":"f64.convert_i32_u","f64.convert_s/i64":"f64.convert_i64_s","f64.convert_u/i64":"f64.convert_i64_u","f64.promote/f32":"f64.promote_f32"};for(let[r,e]of G.entries())e!=null&&(d[e]=r);for(let r in C){let e=G.indexOf(C[r]);d[r]=e}var y={};for(let r in d){y[r]=O(r);let[e,t]=r.split(".");t!=null&&(d[e]=d[e]??{},d[e][t]=d[r],y[e]=y[e]??{},y[e][t]=O(r))}var L={"i32.load":4,"i64.load":8,"f32.load":4,"f64.load":8,"i32.load8_s":1,"i32.load8_u":1,"i32.load16_s":2,"i32.load16_u":2,"i64.load8_s":1,"i64.load8_u":1,"i64.load16_s":2,"i64.load16_u":2,"i64.load32_s":4,"i64.load32_u":4,"i32.store":4,"i64.store":8,"f32.store":4,"f64.store":8,"i32.store8":1,"i32.store16":2,"i64.store8":1,"i64.store16":2,"i64.store32":4};function O(r){return function(e,t){return Q(r,e!=null&&!Array.isArray(e)?[e]:e,t!=null&&!Array.isArray(t)?[t]:t)}}var K={"f64.const":E,"f32.const":T};function*Q(r,e=[],t=[]){for(let s of t)switch(typeof s){case"number":yield s;break;default:yield*s;break}yield d[r];for(let s of e)switch(typeof s){case"bigint":yield*I(s);break;case"number":yield*(K[r]??B)(s);break;default:yield*s}}var X=new TextEncoder("utf-8");function M(r){return[...X.encode(r)]}function P(){return[...M("\0asm"),1,0,0,0]}function u(r,e){return[d.section[r],...b(e.length),...e]}function x(r){return[...b(r.length),...r.flat()]}function Z(r){let e=[],t=[],s;for(let o of r)o!==s&&t.length&&(e.push([...b(t.length),d.type[t[0]]]),t=[]),t.push(o),s=o;return t.length&&e.push([...b(t.length),d.type[t[0]]]),e}function F(r,e,t){return t!=null?[d.limits.shared,...b(r),...b(e)]:e!=null?[d.limits.minmax,...b(r),...b(e)]:[d.limits.min,...b(r)]}u.type=function(r){return u("type",x(r.map(([e,t])=>[d.type.func,...x(e.map(s=>d.type[s])),...x(t.map(s=>d.type[s]))])))};u.import=function(r){return u("import",x(r.map(([e,t,s,o])=>[...x(M(e)),...x(M(t)),d.import[s],...{func:()=>o.map(_=>[...b(_)]),memory:()=>F(...o)}[s]()])))};u.function=function(r){return u("function",x(r.map(e=>[...b(e)])))};u.table=function(r){return u("table",x(r.map(([e,t,s])=>[d.type[e],...F(t,s)])))};u.memory=function(r){return u("memory",x(r.map(([e,t])=>F(e,t))))};u.global=function(r){return u("global",x(r.map(([e,t,s])=>[d.type[t],d.global[e],...s,d.end])))};u.export=function(r){return u("export",x(r.map(([e,t,s])=>[...x(M(e)),d.export[t],...b(s)])))};u.start=function(r){return u("start",[...b(r)])};u.element=function(r){return u("element",x(r.map(([e,t,s])=>[...b(e),...t,d.end,...x(s)])))};u.code=function(r){return u("code",x(r.map(([e,t])=>x([...x(Z(e)),...t,d.end]))))};u.data=function(r){return u("data",x(r.map(([e,t,s])=>[...b(e),...t,d.end,...x(s)])))};var R=class extends Array{log=[];write(e,t){return this.log.push(e,t),this.push(...e),this}get buffer(){return new Uint8Array(this)}},j=class{types=[];imports=[];tables=[];memories=[];globals=[];exports=[];starts="";elements=[];codes=[];datas=[];get funcs(){return this.codes.filter(e=>!e.imported)}ensureType(e,t){let s=[e.join(" "),t.join(" ")].join(),o=this.types.indexOf(s);return o>=0?o:this.types.push(s)-1}getGlobalIndexOf(e){return this.globals.find(t=>t.name===e).idx}getFunc(e){return this.codes.find(t=>t.name===e)}getMemory(e){return this.memories.find(t=>t.name===e)}getType(e){return this.types[e]}type(e,t,s){return this.types[e]=this.ensureType(t,s),this}import(e,t,s,o,_,g){if(e==="func"){let m=this._func(t,_,g,[],[],!1,!0);this.imports.push({mod:s,field:o,type:e,desc:[m.type_idx]})}else e==="memory"&&this.imports.push({mod:s,field:o,type:e,desc:_});return this}table(e,t,s){return this.tables.push({type:e,min:t,max:s}),this}memory(e,t,s){return this.memories.push({name:e,min:t,max:s}),this}global(e,t,s,o){let _=this.globals.length;return this.globals.push({idx:_,name:e,valtype:s,mut:t,expr:o}),this}export(e,t,s){return this.exports.push({type:e,name:t,export_name:s}),this}start(e){return this.starts=e,this}elem(e,t){return this.elements.push({offset_idx_expr:e,codes:t}),this}_func(e,t=[],s=[],o=[],_=[],g=!1,m=!1){let f=this.ensureType(t,s),i={idx:this.codes.length,name:e,type_idx:f,locals:o,body:_,imported:m};return this.codes.push(i),g&&this.export("func",e,e),i}func(...e){return this._func(...e),this}data(e,t){return this.datas.push({offset_idx_expr:e,bytes:t}),this}build({metrics:e=!0}={}){e&&console.time("module build");let t=new R;return t.write(P()),this.types.length&&t.write(u.type(this.types.map(s=>s.split(",").map(o=>o.split(" ").filter(Boolean))))),this.imports.length&&t.write(u.import(this.imports.map(s=>[s.mod,s.field,s.type,s.desc]))),this.funcs.length&&t.write(u.function(this.funcs.map(s=>s.type_idx))),this.elements.length&&t.write(u.table(this.tables.map(s=>[s.type,s.min,s.max]))),this.memories.length&&t.write(u.memory(this.memories.map(s=>[s.min,s.max]))),this.globals.length&&t.write(u.global(this.globals.map(s=>[s.mut,s.valtype,s.expr]))),this.exports.length&&t.write(u.export(this.exports.map(s=>s.type==="func"?[s.export_name,s.type,this.getFunc(s.name).idx]:s.type==="memory"?[s.export_name,s.type,this.getMemory(s.name).idx]:[]))),this.starts.length&&t.write(u.start(this.getFunc(this.starts).idx)),this.elements.length&&t.write(u.element(this.elements.map(s=>[0,s.offset_idx_expr,s.codes.map(o=>this.getFunc(o).idx)]))),this.funcs.length&&t.write(u.code(this.funcs.map(s=>[s.locals,s.body]))),this.datas.length&&t.write(u.data(this.datas.map(s=>[0,s.offset_idx_expr,s.bytes]))),e&&console.timeEnd("module build"),t}};var $=class{globals=[];types=[];funcs=[];lookup(e,t){let s;switch(t){case"call":s=this.funcs.map(o=>o.name).lastIndexOf(e);break;case"type":s=this.types.map(o=>o.name).lastIndexOf(e);break;default:s=this.globals.map(o=>o.name).lastIndexOf(e)}return b(s)}};function z(r){let e=new j,t=new $,s=[];function o(n,i=t,a="i32"){switch(n.kind){case"number":{if(n.value==="inf"||n.value==="+inf")return 1/0;if(n.value==="-inf")return-1/0;if(n.value==="nan"||n.value==="+nan")return NaN;if(n.value==="-nan")return NaN;if(a?.[0]==="f")return parseFloat(n.value)}case"hex":{let l;return a.indexOf("i64")===0?(n.value[0]==="-"?l=-BigInt(n.value.slice(1)):l=BigInt(n.value),l):a[0]==="f"?(n.value.indexOf("nan")>=0?a.indexOf("f32")===0?l=q(n.value):l=U(n.value):l=S(n.value),l):parseInt(n.value)}case"label":return i.lookup(n.value,a);default:return n.value}}class _{locals=[];depth=[];lookup(i,a){let l;switch(a){case"br":case"br_table":case"br_if":l=this.depth.lastIndexOf(i),~l&&(l=this.depth.length-1-l);break;default:l=this.locals.lastIndexOf(i)}return~l?b(l):t.lookup(i,a)}}function g(n,i,a){if(!(n in y)||typeof y[n]!="function")throw new Error("Unknown instruction: "+n);return[...y[n](i,a)]}function m(n,i=t){let a={offset:0,align:0},l=n.instr.value;switch(l){case"type":return e.getType(n.name.value);case"call_indirect":{let c=[m(n.children.shift(),i),0],h=n.children.flatMap(p=>m(p,i));return g(l,c,h)}case"memory.grow":{let c=[0],h=n.children.flatMap(p=>m(p,i));return g(l,c,h)}case"i32.load":case"i64.load":case"f32.load":case"f64.load":case"i32.load8_s":case"i32.load8_u":case"i32.load16_s":case"i32.load16_u":case"i64.load8_s":case"i64.load8_u":case"i64.load16_s":case"i64.load16_u":case"i64.load32_s":case"i64.load32_u":case"i32.store":case"i64.store":case"f32.store":case"f64.store":case"i32.store8":case"i32.store16":case"i64.store8":case"i64.store16":case"i64.store32":{a.align=L[l];for(let p of n.params)a[p.param.value]=o(p.value);let c=[Math.log2(a.align),a.offset].map(p=>{if(typeof p=="number")return b(p);if(typeof p=="bigint")return I(p)}),h=n.children.flatMap(p=>m(p,i));return g(l,c,h)}case"func":{let c={name:n.name?.value??t.funcs.length,params:[],results:[]};t.funcs.push(c);for(let h of n.children)switch(h.instr.value){case"param":c.params.push(...h.children.map(p=>p.instr.value));break;case"result":c.results.push(...h.children.map(p=>p.instr.value));break}return[c.name,c.params,c.results]}case"result":return n.children.flatMap(c=>y.type[c.instr.value]());case"else":case"then":return n.children.flatMap(c=>m(c,i));case"if":{let c=n.name?.value??i.depth.length,h=[],p=[],w;i.depth.push(c);for(let k of n.children)switch(k.instr.value){case"result":h.push(m(k,i));break;case"else":p.push(...y.else());case"then":p.push(m(k,i));break;default:w=m(k,i)}return i.depth.pop(),h.length||h.push(y.type.void()),[...y.if(h.flat(),w),...p.flat(),...y.end()]}case"loop":case"block":{let c=n.name?.value??i.depth.length,h=[],p=[];i.depth.push(c);for(let w of n.children)switch(w.instr.value){case"result":h.push(m(w,i));break;default:p.push(m(w,i))}return i.depth.pop(),h.length||h.push(y.type.void()),[...y[l](),...h.flat().map(w=>[...w]),...p.flat(),...y.end()]}case"br_table":{n.name&&n.params.unshift({param:{value:i.lookup(n.name.value,l)}});let c=n.params.map(p=>o(p.param,i,l)),h=n.children.flatMap(p=>m(p,i));return g(l,[c.length-1,...c],h)}default:{n.name&&n.params.unshift({param:{value:(l.startsWith("global")?t:i).lookup(n.name.value,l)}});let c=n.params.map(p=>o(p.param,i,l)),h=n.children.flatMap(p=>m(p,i));return g(l,c,h)}}}function f(n){switch(n.instr.value){case"module":n.children.forEach(i=>f(i));break;case"memory":{let i=n.name?.value??e.memories.length,a=n.params.map(l=>o(l.param)).flat();if(n.children?.[0]?.instr.value==="export"){let l=n.children[0].params[0].param.value,c=n.children[0].name?.value??0;e.export("memory",c,l)}e.memory(i,...a)}break;case"data":{let i=n.children.shift(),a=n.children.shift().data;e.data(m(i),a)}break;case"start":e.start(n.name.value);break;case"table":{let i=n.params.map(a=>o(a.param));i.unshift(i.pop()),e.table(...i)}break;case"elem":{let i=n.children.shift(),a=n.children.map(l=>l.ref.value);e.elem(m(i),a)}break;case"import":if(n.children[0].instr.value==="func"){let i=n.params.map(c=>o(c.param)),a=m(n.children[0]),l=a.shift();e.import("func",l,...i,...a)}else if(n.children[0].instr.value==="memory"){let i=n.children[0],a=n.params.map(h=>o(h.param)),l=i.instr.name,c=i.params.map(h=>o(h.param));e.import("memory",l,...a,c)}break;case"global":{let i={name:n.name?.value??e.globals.length,vartype:"const",type:n.children[0].instr.value};t.globals.push(i),i.type==="mut"&&(i.vartype="var",i.type=n.children[0].children[0].instr.value);let a=n.children[1];e.global(i.name,i.vartype,i.type,m(a))}break;case"type":{let i={name:n.name?.value??e.types.length,params:[],results:[]};t.types.push(i);for(let a of n.children[0].children)switch(a.instr.value){case"param":i.params.push(...a.children.map(l=>l.instr.value));break;case"result":i.results.push(...a.children.map(l=>l.instr.value));break}e.type(i.name,i.params,i.results)}break;case"export":{let i={name:n.params[0].param.value};i.type=n.children[0].instr.value,i.internal_name=n.children[0].name.value,e.export(i.type,i.internal_name,i.name)}break;case"func":{let i={name:n.name?.value??t.funcs.length,context:new _,params:[],results:[],locals:[],body:[]};t.funcs.push(i);for(let a of n.children)switch(a.instr.value){case"export":{let l=a.params[0].param.value;e.export("func",i.name,l)}break;case"local":i.locals.push(...a.children.map(l=>l.instr.value)),i.context.locals.push(...a.children.map(()=>a.name?.value));break;case"param":i.params.push(...a.children.map(l=>l.instr.value)),i.context.locals.push(...a.children.map(()=>a.name?.value));break;case"result":i.results.push(...a.children.map(l=>l.instr.value));break;default:i.body.push(a)}s.push(()=>{e.func(i.name,i.params,i.results,i.locals,[...i.body.flatMap(a=>m(a,i.context))])})}break}}return f(r),s.forEach(n=>n()),e}function ee(r,e){return z(N(A("(module "+r+")"))).build(e).buffer}export{ee as default};
